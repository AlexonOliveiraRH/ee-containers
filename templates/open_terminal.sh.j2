#!/bin/bash

IS_WSL="${1:-False}"

# Ensure the session exists first
if ! tmux has-session -t podman-monitor 2>/dev/null; then
  echo "No tmux session found - starting a new one first"
  # Launch the monitor script to create the session
  bash "$(dirname "$0")/start_monitor.sh"
  # Wait briefly for session to initialize
  sleep 2
fi

if [ "$IS_WSL" = "True" ]; then
  echo "Running in WSL environment, trying Windows Terminal methods..."
  
  # Clear any existing terminal session
  tmux kill-session -t wt-launcher 2>/dev/null || true
  
  # Create a dedicated script for the terminal launch
  cat > /tmp/wt_launcher.sh << 'EOF'
#!/bin/bash
tmux attach -t podman-monitor || echo "No tmux session found - running start_monitor.sh" 
sleep 10
EOF
  chmod +x /tmp/wt_launcher.sh
  
  # Try different methods to launch Windows Terminal
  
  # Method 1: wslg (most modern WSL2 installations)
  if [ -n "$WSLG_DIR" ] || [ -n "$DISPLAY" ]; then
    echo "WSLg detected, trying graphical launch..."
    x-terminal-emulator -e "bash /tmp/wt_launcher.sh" &
    exit 0
  fi
  
  # Method 2: Direct wt.exe call with explicit path
  echo "Trying Windows Terminal launch via wt.exe..."
  for wt_path in "/mnt/c/Program Files/WindowsApps/Microsoft.WindowsTerminal"*/wt.exe; do
    if [ -x "$wt_path" ]; then
      "$wt_path" -d . wsl.exe -d $(wsl.exe -l | grep -v "Windows Subsystem for Linux Distributions:" | head -1 | tr -d " \t\r") bash -c "/tmp/wt_launcher.sh" &
      exit 0
    fi
  done
  
  # Method 3: PowerShell approach with direct command
  echo "Trying PowerShell launch method..."
  powershell.exe -Command "Start-Process wt.exe -ArgumentList '-d', '.', 'wsl.exe', '-d', '$(wsl.exe -l | grep -v 'Windows Subsystem for Linux Distributions:' | head -1 | tr -d ' \t\r')', 'bash', '-c', '/tmp/wt_launcher.sh'" &
  
  echo "Manual connection instructions:"
  echo "1. Open Windows Terminal manually"
  echo "2. Run: tmux attach -t podman-monitor"
else
  # Standard Linux approaches
  if command -v x-terminal-emulator >/dev/null 2>&1; then
    x-terminal-emulator -e "tmux attach -t podman-monitor || echo No tmux session found" &
  elif command -v gnome-terminal >/dev/null 2>&1; then
    gnome-terminal -- bash -c "tmux attach -t podman-monitor || echo No tmux session found" &
  elif command -v xterm >/dev/null 2>&1; then
    xterm -e "tmux attach -t podman-monitor || echo No tmux session found" &
  elif command -v konsole >/dev/null 2>&1; then
    konsole -e "tmux attach -t podman-monitor || echo No tmux session found" &
  fi
fi

exit 0
