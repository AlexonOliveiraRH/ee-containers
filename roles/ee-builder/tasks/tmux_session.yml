# Create a build monitor in a tmux session
- name: Setup Podman build monitor in tmux
  block:
    # Create script to setup the tmux monitoring session
    - name: Create tmux monitor script
      ansible.builtin.copy:
        dest: "/tmp/ee-containers/build_monitor.sh"
        mode: "0755"
        content: |
          #!/bin/bash
          
          # Setup tmux session for monitoring
          tmux new-session -d -s podman_monitor
          tmux rename-window -t podman_monitor "Build Monitor"
          
          # Add header
          tmux send-keys -t podman_monitor "echo '╔════════════════════════════════════════════════════════════════╗'" Enter
          tmux send-keys -t podman_monitor "echo '║                ANSIBLE PODMAN BUILD MONITOR                     ║'" Enter
          tmux send-keys -t podman_monitor "echo '╚════════════════════════════════════════════════════════════════╝'" Enter
          
          # Split window and run image watch
          tmux split-window -v -t podman_monitor
          tmux send-keys -t podman_monitor:0.1 "watch -n 1 'podman images | sort'" Enter
          
          # Monitor build status
          tmux select-pane -t podman_monitor:0.0
          tmux send-keys -t podman_monitor:0.0 "while true; do clear; cat /tmp/ee-containers/build_status.txt 2>/dev/null || echo 'Waiting for build to start...'; echo ''; sleep 1; done" Enter
          
          # Keep session running
          tmux -2 attach-session -t podman_monitor

    # Launch the monitoring script in a new terminal
    - name: Launch tmux monitor
      ansible.builtin.shell: |
        xterm -e "bash /tmp/ee-containers/build_monitor.sh" &
      async: 0
      poll: 0
      ignore_errors: true
      changed_when: false

    # Create initial status file
    - name: Create build status file for monitor
      ansible.builtin.copy:
        dest: "/tmp/ee-containers/build_status.txt"
        content: "Ready to build: {{ environments_to_build | join(', ') }}"
        mode: "0644"
      changed_when: false
  ignore_errors: true
