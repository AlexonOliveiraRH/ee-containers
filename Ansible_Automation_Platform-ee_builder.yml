---
# Ansible Automation Platform - Execution Environment Builder
# This playbook builds customized execution environments based on Red Hat AAP base images

# Play 1: Verify or collect credentials
- name: Setup and store credentials
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    # Improved user detection logic
    - name: Get effective and real user info
      ansible.builtin.shell: |
        echo "EUID=$(id -u)"
        if [ -n "$SUDO_USER" ]; then
          echo "SUDO_USER=$SUDO_USER"
          echo "SUDO_UID=$(id -u $SUDO_USER)"
          echo "SUDO_HOME=$(eval echo ~$SUDO_USER)"
        else
          echo "SUDO_USER="
          echo "SUDO_UID="
          echo "SUDO_HOME="
        fi
        echo "USER=$(whoami)"
        echo "HOME=$HOME"
      register: user_info_output
      changed_when: false
      tags: [always]
    
    - name: Parse user info
      ansible.builtin.set_fact:
        parsed_user_info: "{{ dict(user_info_output.stdout_lines | map('regex_replace', '^([^=]+)=(.*)$', '\\1:\\2') | map('split', ':') | list) }}"
      tags: [always]
    
    - name: Set user facts
      ansible.builtin.set_fact:
        is_root: "{{ parsed_user_info.EUID == '0' }}"
        actual_user: "{{ parsed_user_info.SUDO_USER | default(parsed_user_info.USER) }}"
        user_home: "{{ parsed_user_info.SUDO_HOME | default(parsed_user_info.HOME) }}"
      tags: [always]
    
    - name: Debug user detection
      ansible.builtin.debug:
        msg: |
          User detection results:
          - Effective UID: {{ parsed_user_info.EUID }}
          - Running as root: {{ is_root }}
          - Original user: {{ actual_user }}
          - User home: {{ user_home }}
      tags: [always]

    # Skip credential setup if running as root directly (not via sudo)
    - name: Skip credential setup if running as root directly
      ansible.builtin.set_fact:
        skip_credential_setup: "{{ ansible_user_id == 'root' and lookup('env', 'SUDO_USER') == '' }}"
      tags: [always]

    - name: Show credential setup status
      ansible.builtin.debug:
        msg: "{{ skip_credential_setup | ternary('Running as direct root user - skipping credential setup', 'Setting up credentials for user ' + actual_user) }}"
      tags: [always]

    # Only run credential setup if not skipping
    - name: Setup user credentials
      when: not skip_credential_setup
      block:
        - name: Ensure ansible vars directory exists in user's home
          ansible.builtin.file:
            path: "{{ user_home }}/.ansible/vars"
            state: directory
            mode: '0700'
          tags: [setup, credential_setup]
    
        - name: Check if credentials file exists
          ansible.builtin.stat:
            path: "{{ user_home }}/.ansible/vars/config"
          register: config_file
          tags: [always]
    
        - name: Set first run flag 
          ansible.builtin.set_fact:
            first_run: "{{ not config_file.stat.exists }}"
          tags: [always]
    
        - name: Load stored credentials if they exist
          ansible.builtin.include_vars:
            file: "{{ user_home }}/.ansible/vars/config"
            name: stored_credentials
          when: config_file.stat.exists
          tags: [always]
    
        - name: Request credentials if needed
          block:
            - name: Collect Red Hat CDN username
              ansible.builtin.pause:
                prompt: "Enter your Red Hat CDN username"
                echo: true
              register: rh_username_input
              when: stored_credentials is not defined or stored_credentials.rh_username is not defined
              
            - name: Collect Red Hat CDN password
              ansible.builtin.pause:
                prompt: "Enter your Red Hat CDN password"
                echo: false
              register: rh_password_input
              when: stored_credentials is not defined or stored_credentials.rh_password is not defined
              
            - name: Collect Automation Hub token
              ansible.builtin.pause:
                prompt: "Enter your Automation Hub token (or press enter to skip)"
                echo: false
              register: automation_hub_token_input
              when: stored_credentials is not defined or stored_credentials.automation_hub_token is not defined
              
            - name: Collect Galaxy token
              ansible.builtin.pause:
                prompt: "Enter your Galaxy token (or press enter to skip)"
                echo: false
              register: galaxy_token_input
              when: stored_credentials is not defined or stored_credentials.galaxy_token is not defined
              
            - name: Set collected credential facts
              ansible.builtin.set_fact:
                rh_username: "{{ rh_username_input.user_input | default(stored_credentials.rh_username | default('')) }}"
                rh_password: "{{ rh_password_input.user_input | default(stored_credentials.rh_password | default('')) }}"
                automation_hub_token: "{{ automation_hub_token_input.user_input | default(stored_credentials.automation_hub_token | default('')) }}"
                galaxy_token: "{{ galaxy_token_input.user_input | default(stored_credentials.galaxy_token | default('')) }}"
              no_log: true
              
            - name: Create credentials file
              ansible.builtin.copy:
                dest: "{{ user_home }}/.ansible/vars/config"
                content: |
                  ---
                  # Ansible EE Builder Configuration - Last updated {{ ansible_date_time.iso8601 }}
                  rh_username: '{{ rh_username }}'
                  rh_password: '{{ rh_password }}'
                  automation_hub_token: '{{ automation_hub_token }}'
                  galaxy_token: '{{ galaxy_token }}'
                mode: '0600'
                # Remove owner and group attributes when running as root
              no_log: true
              
            - name: Set proper ownership on credentials file when needed
              ansible.builtin.file:
                path: "{{ user_home }}/.ansible/vars/config"
                owner: "{{ actual_user }}"
                group: "{{ actual_user }}"
                mode: '0600'
              when: actual_user != 'root' and actual_user != ''
              no_log: true
              
            - name: Report stored credentials
              ansible.builtin.debug:
                msg: |
                  ┌────────────────────────────────────────────────────────────────┐
                  │                  CREDENTIALS STORED                            │
                  ├────────────────────────────────────────────────────────────────┤
                  │ Credentials have been stored at: {{ user_home }}/.ansible/vars/config │
                  │ These will be used for future runs.                            │
                  └────────────────────────────────────────────────────────────────┘
          when: first_run or (stored_credentials is not defined)
          tags: [always]
    
    - name: Fail if not running with sudo
      ansible.builtin.fail:
        msg: |
          This playbook must be run as root or with sudo privileges for full functionality.
          
          For a full run to build environments, use:
            sudo ansible-playbook Ansible_Automation_Platform-ee_builder.yml -K
      when: not is_root
      tags: [always]
      
    - name: Show run mode
      ansible.builtin.debug:
        msg: |
          ┌────────────────────────────────────────────────────────────────────┐
          │                     RUN MODE INFORMATION                           │
          ├────────────────────────────────────────────────────────────────────┤
          │ {{ "FIRST RUN DETECTED: Running full setup" if first_run|default(false) else "SUBSEQUENT RUN: Using stored configuration" }} │
          │                                                                    │
          │ User: {{ actual_user }}                                            │
          │ Credentials: {{ "New" if first_run|default(false) else "Loaded from file" }}      │
          └────────────────────────────────────────────────────────────────────┘
      tags: [always]

    # Use sudo_user's home directory for config in the main play
    - name: Set config path for main play
      ansible.builtin.set_fact:
        config_path: "{{ user_home }}/.ansible/vars/config"
      tags: [always]

# Play 2: Display title and introduction
- name: Display title screen
  hosts: localhost
  connection: local
  gather_facts: false
  environment:
    ANSIBLE_LOCALHOST_WARNING: "False" 
    ANSIBLE_DEPRECATION_WARNINGS: "False"
    ANSIBLE_COMMAND_WARNINGS: "False"
    ANSIBLE_SYSTEM_WARNINGS: "False"
  tasks:
    - name: Clear screen before showing title
      ansible.builtin.shell: clear
      changed_when: false
      
    - name: Show title
      ansible.builtin.debug:
        msg: |
          ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
          │                                                                                      ..:-=@@@@=-:..          │
          │                                                                                    .*%@@@@@@@@@@@@%*.        │
          │                                                                                 .:@@@@@@@@@@@@@@@@@@@@:.     │
          │                                                                                .*@@@@@@@@@@*-@@@@@@@@@@*.    │
          │                                                                               .@@@@@@@@@@@*. =@@@@@@@@@@@.   │
          │                                                                              .%@@@@@@@@@@@ .@ +@@@@@@@@@@%.  │
          │                                                                              -%@@@@@@@@@@..@%-.*@@@@@@@@@%-  │
          │     "A Streamlined Approach to Building Ansible Execution Environments"     .+@@@@@@@@@@= =@@@.:@@@@@@@@@@+. │
          │                                                                             .+@@@@@@@@@@ ..:+@%.-@@@@@@@@@+. │
          │                                                                             .=@@@@@@@@@ .@@+. *+.-@@@@@@@%=  │
          │                                                                              .%@@@@@@@:.*@@@@%.  .+@@@@@@%.  │
          │                                                                               .@@@@@@= =@@@@@@@%=.:%@@@@@.   │
          │                                                                                :%@@@@@@@@@@@@@@@@@@@@@@%:    │
          │                                                                                 .*@@@@@@@@@@@@@@@@@@@@*.     │
          │                                                                                   .+@@@@@@@@@@@@@@@@+..      │
          │                                                                                     ..+*%@@@@@@%*+..         │
          └──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
      tags: [always]

    - name: Pause for title screen
      ansible.builtin.pause:
        seconds: 3
        prompt: "Starting Execution Environment Builder..."
      tags: [always]

# Play 3: Main execution environment building process
- name: Build Execution Environments for Ansible Automation Platform
  hosts: localhost
  become: true
  gather_facts: true
  vars_files:
    - "{{ hostvars.localhost.config_path | default('~/.ansible/vars/config') }}"

  # Variables definition section remains the same
  vars:
    # Connection variables
    container_registries:
      - registry.redhat.io
      - console.redhat.com
      - registry.access.redhat.com
      - quay.io
      - registry.connect.redhat.com
    dns_servers:
      - '8.8.8.8'
      - '8.8.4.4'
    
    # Package and dependency variables
    required_packages:
      - python3-pip
      - ansible-builder
      - ansible-core
      - git
      - podman
      - podman-docker
      - tmux
      - xdg-utils
      - yum-utils
    
    # Always update the protected_images list in defaults/main.yml
    update_protected_list: true
    
    # Repository variables  
    git_repos:
      - url: 'https://github.com/cloin/ee-builds.git'
        dest: 'examples/ee-builds'
    work_dir: '/tmp/ee-containers'
    
    # Container image variables
    required_images:
      - registry.redhat.io/ansible-automation-platform-25/de-minimal-rhel8
      - registry.redhat.io/ansible-automation-platform-25/de-minimal-rhel9
      - registry.redhat.io/ansible-automation-platform-25/de-supported-rhel8
      - registry.redhat.io/ansible-automation-platform-25/de-supported-rhel9
      - registry.redhat.io/ansible-automation-platform-25/ee-minimal-rhel8
      - registry.redhat.io/ansible-automation-platform-25/ee-minimal-rhel9
      - registry.redhat.io/ansible-automation-platform-25/ee-supported-rhel8
      - registry.redhat.io/ansible-automation-platform-25/ee-supported-rhel9

  # Interactive variables - now using defaults from config file
  vars_prompt:
    - name: distribution_selection
      prompt: "Select distribution to build images for (8/9/both)"
      private: false
      default: "both"

  pre_tasks:
    - name: Check root status
      ansible.builtin.command: id -u
      register: user_id
      changed_when: false
      tags: [always]

    - name: Set root flag
      ansible.builtin.set_fact:
        is_root: "{{ user_id.stdout == '0' }}"
      tags: [always]

    - name: Warning if running as non-root
      ansible.builtin.debug:
        msg: |
          Running in LIMITED MODE as non-root user.
          Only setup tasks will be executed.
          For full functionality, run with sudo.
      when: not is_root
      tags: [always]

    # Rest of the tasks with proper conditional checks
    - name: Set Podman warning suppression environment variable
      ansible.builtin.set_fact:
        podman_env:
          PODMAN_IGNORE_CGROUPSV1_WARNING: "1"
      tags: [setup, env_config, podman_warnings]
      
    - name: Add Podman warning suppression to environment files
      ansible.builtin.lineinfile:
        path: "{{ item }}"
        regexp: '^export PODMAN_IGNORE_CGROUPSV1_WARNING='
        line: 'export PODMAN_IGNORE_CGROUPSV1_WARNING=1'
        create: true
        mode: '0644'
      with_items:
        - /etc/environment
        - /etc/profile.d/podman.sh
      when: is_root
      tags: [setup, env_config, podman_env_files]
      
    - name: Create systemd environment override for podman
      ansible.builtin.copy:
        content: |
          [Service]
          Environment=PODMAN_IGNORE_CGROUPSV1_WARNING=1
        dest: /etc/systemd/system/podman.service.d/environment.conf
        mode: '0644'
        create: true
      when: is_root
      
    - name: Reload systemd configuration
      ansible.builtin.systemd:
        daemon_reload: true
      when: is_root
    
    #
    # SECTION 1: Distribution Selection
    #
    - name: Process distribution selection
      ansible.builtin.set_fact:
        build_rhel8: "{{ distribution_selection == '8' or distribution_selection == 'both' }}"
        build_rhel9: "{{ distribution_selection == '9' or distribution_selection == 'both' }}"
      tags: [setup, distribution, dist_selection]
        
    - name: Show selected distributions
      ansible.builtin.debug:
        msg: "Building images for: {{ (build_rhel8 | bool) | ternary('RHEL 8', '') }}{{ (build_rhel8 and build_rhel9) | ternary(' and ', '') }}{{ (build_rhel9 | bool) | ternary('RHEL 9', '') }}"
      tags: [setup, distribution, dist_show_selected]
    
    - name: Filter required images based on distribution selection
      ansible.builtin.set_fact:
        filtered_images: >-
          {{
            (build_rhel8 | bool) | ternary(required_images | select('search', 'rhel8') | list, []) +
            (build_rhel9 | bool) | ternary(required_images | select('search', 'rhel9') | list, [])
          }}

    - name: Show filtered image list
      ansible.builtin.debug:
        msg: |
          Images selected for download:
          {% for image in filtered_images %}
          - {{ image }}
          {% endfor %}
      when: filtered_images | length > 0
        
    - name: Update required_images with filtered list
      ansible.builtin.set_fact:
        required_images: "{{ filtered_images }}"
      when: filtered_images is defined and filtered_images | length > 0

    #
    # SECTION 2: Base System Configuration
    #
    - name: Detect RHEL version
      ansible.builtin.set_fact:
        rhel_version: "{{ ansible_distribution_major_version | default('9') }}"
      tags: [setup, system_config, detect_rhel]
      
    - name: Enable required RHEL repositories based on version
      block:
        - name: Enable RHEL 8 repositories
          ansible.builtin.command:
            cmd: "subscription-manager repos --enable={{ item }}"
          loop:
            - rhel-8-for-x86_64-supplementary-rpms
            - rhel-8-for-x86_64-appstream-rpms
            - rhel-8-for-x86_64-baseos-rpms
            - codeready-builder-for-rhel-8-x86_64-rpms
          register: repo_enable_rhel8
          changed_when: repo_enable_rhel8.rc == 0
          failed_when: false
          loop_control:
            label: "{{ item }}"
          when: rhel_version == '8' and build_rhel8 | bool and is_root
          tags: [setup, system_config, repositories, rhel8_repos]
          
        - name: Enable RHEL 9 repositories
          ansible.builtin.command:
            cmd: "subscription-manager repos --enable={{ item }}"
          loop:
            - rhel-9-for-x86_64-supplementary-rpms
            - rhel-9-for-x86_64-appstream-rpms
            - rhel-9-for-x86_64-baseos-rpms
            - codeready-builder-for-rhel-9-x86_64-rpms
          register: repo_enable_rhel9
          changed_when: repo_enable_rhel9.rc == 0
          failed_when: false
          loop_control:
            label: "{{ item }}"
          when: rhel_version == '9' and build_rhel9 | bool and is_root
          tags: [setup, system_config, repositories, rhel9_repos]
          
        - name: Check enabled repositories
          ansible.builtin.command:
            cmd: "subscription-manager repos --list-enabled"
          register: enabled_repos
          changed_when: false
          failed_when: false
          tags: [setup, system_config, repositories, list_repos]
          
        - name: Display enabled repositories
          ansible.builtin.debug:
            msg: |
              Currently enabled repositories for RHEL {{ rhel_version }}:
              {% for line in enabled_repos.stdout_lines %}
              {% if 'Repo ID:' in line %}
              - {{ line | regex_replace('^Repo ID:\\s+', '') }}
              {% endif %}
              {% endfor %}
          when: enabled_repos.rc == 0
          tags: [setup, system_config, repositories, show_repos]
      rescue:
        - name: Handle repository configuration failure
          ansible.builtin.debug:
            msg: "Warning: Failed to enable some repositories. Continuing with available repositories."
          tags: [setup, system_config, repositories, error_handling]
      tags: [setup, system_config, repositories]

    #
    # SECTION 3: DNS and Network Setup
    #
    - name: Verify DNS resolution
      ansible.builtin.command:
        cmd: "nslookup {{ item }}"
      loop:
        - github.com
        - cdn-ubi.redhat.com
        - galaxy.ansible.com
      register: dns_checks
      changed_when: false
      failed_when: false
      loop_control:
        label: "{{ item }}"

    - name: Set DNS servers for Podman
      ansible.builtin.template:
        src: templates/registries.conf.j2
        dest: /etc/containers/registries.conf
        mode: '0644'
        backup: true
      when: is_root
      tags: [setup, network_config, dns_servers]

    #
    # SECTION 4: Podman Configuration Reset
    #
    - name: Complete Podman storage system reset
      block:
        - name: Show critical error message
          ansible.builtin.debug:
            msg: |
              Performing complete system reset of Podman storage.
              This will delete all local container images and data!

        - name: Stop all Podman processes
          ansible.builtin.shell: |
            # Kill all running containers
            podman ps -qa | xargs -r podman kill
            podman ps -qa | xargs -r podman rm -f
            
            # Stop podman service
            systemctl stop podman.service podman.socket || true
            
            # Kill any remaining podman processes
            pkill -9 podman || true
          changed_when: true
          ignore_errors: true
          
        - name: Remove entire container configuration
          ansible.builtin.shell: |
            # Remove all container storage
            rm -rf /var/lib/containers/*
            rm -rf /run/containers/*
            rm -rf /run/libpod/*
            rm -rf /run/user/*/containers/*
            
            # Remove caches and temporary files
            rm -rf /root/.local/share/containers/*
            rm -rf /home/*/.local/share/containers/* || true
            rm -rf /tmp/containers-*
            rm -rf /tmp/libpod-*
            
            # Remove runtime files
            rm -f /run/libpod/runc*
          changed_when: true
          ignore_errors: true
          
        - name: Create basic container configuration files
          ansible.builtin.shell: |
            mkdir -p /etc/containers/containers.conf.d
            mkdir -p /etc/containers/storage.conf.d
            
            # Create base storage configuration
            cat > /etc/containers/storage.conf << EOF
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            
            [storage.options]
            additionalimagestores = []
            
            [storage.options.overlay]
            mountopt = "nodev,metacopy=on"
            mount_program = "/usr/bin/fuse-overlayfs"
            ignore_chown_errors = "false"
            EOF
            
            # Create minimal registries configuration
            cat > /etc/containers/registries.conf << EOF
            [registries.search]
            registries = ['docker.io', 'registry.fedoraproject.org', 'registry.access.redhat.com', 'quay.io']
            
            [registries.insecure]
            registries = []
            
            [registries.block]
            registries = []
            EOF
          changed_when: true
          ignore_errors: true
          
        - name: Create container directory structure from scratch
          ansible.builtin.shell: |
            # Create essential directories with proper permissions
            mkdir -p /var/lib/containers/storage/overlay
            mkdir -p /var/lib/containers/storage/overlay-layers
            mkdir -p /var/lib/containers/storage/overlay-images
            mkdir -p /var/lib/containers/storage/vfs
            mkdir -p /var/lib/containers/storage/vfs-containers
            mkdir -p /var/lib/containers/storage/vfs-images
            mkdir -p /var/lib/containers/storage/vfs-layers
            mkdir -p /run/containers/storage
            
            # Set proper ownership
            chown -R root:root /var/lib/containers
            chown -R root:root /run/containers
          changed_when: true
          
        - name: Export environment variables to disable warnings
          ansible.builtin.shell: |
            # Add to environment
            export PODMAN_IGNORE_CGROUPSV1_WARNING=1
            
            # Add to current shell and .bashrc
            echo 'export PODMAN_IGNORE_CGROUPSV1_WARNING=1' >> ~/.bashrc
            
            # Create systemd override for podman service
            mkdir -p /etc/systemd/system/podman.service.d/
            cat > /etc/systemd/system/podman.service.d/environment.conf << EOF
            [Service]
            Environment=PODMAN_IGNORE_CGROUPSV1_WARNING=1
            EOF
            
            # Reload systemd to pick up changes
            systemctl daemon-reload
            systemctl restart podman.socket podman.service || true
          changed_when: true
      when: is_root
    
    #
    # SECTION 5: Registry Authentication
    #
    - name: Setup Red Hat registry authentication
      block:
        - name: Verify podman is working properly
          ansible.builtin.command:
            cmd: "podman info --format 'Driver: {{ '{{' }} .Store.GraphDriverName {{ '}}' }}'"
          environment:
            PODMAN_IGNORE_CGROUPSV1_WARNING: "1"
          register: podman_check
          failed_when: podman_check.rc != 0
        
        - name: Initialize registry login tracking
          ansible.builtin.set_fact:
            registry_login_success: false
            registry_login_results: {}
        
        - name: Login to container registries
          ansible.builtin.command:
            cmd: "podman login --username {{ rh_username }} --password {{ rh_password }} {{ item }}"
          environment: "{{ podman_env }}"
          no_log: true
          register: registry_logins
          changed_when: registry_logins.rc == 0
          failed_when: false
          loop: "{{ container_registries }}"
          loop_control:
            label: "{{ item }}"
          tags: [setup, registry, registry_login]
            
        - name: Process registry login results
          ansible.builtin.set_fact:
            registry_login_success: >-
              {{ registry_login_success or 
                 (item.item != 'quay.io' and item.rc == 0) }}
            registry_login_results: "{{ registry_login_results | combine({item.item: (item.rc == 0)}) }}"
          loop: "{{ registry_logins.results }}"
          loop_control:
            label: "{{ item.item }}"
            
        - name: Display registry login status
          ansible.builtin.debug:
            msg: |
              Registry Authentication Results:
              {% for registry, success in registry_login_results.items() %}
              - {{ registry }}: {{ 'SUCCESS' if success else 'FAILED' }}
              {% endfor %}
              
        - name: Fail if authentication failed for all critical registries
          ansible.builtin.fail:
            msg: |
              CRITICAL ERROR: Failed to authenticate with any required container registries.
              Authentication to at least one Red Hat registry is required for this playbook to function.
              Please check your Red Hat credentials and network connectivity.
          when: not registry_login_success

    #
    # SECTION 6: Builder Configuration
    #
    - name: Configure ansible-builder
      block:
        - name: Check if ansible-builder is already installed
          ansible.builtin.shell: which ansible-builder || echo "not found"
          register: ansible_builder_check
          changed_when: false

        - name: Install ansible-builder via pip if not found
          ansible.builtin.pip:
            name: ansible-builder
            state: present
            extra_args: "--user"
          when: "'not found' in ansible_builder_check.stdout"
          
        - name: Create ansible.cfg in build context
          ansible.builtin.template:
            src: templates/ansible.cfg.j2
            dest: "{{ work_dir }}/_build/configs/ansible.cfg"
            mode: '0644'
          vars:
            automation_hub_token: "{{ automation_hub_token | default('') }}"
            current_user: "{{ ansible_user_id | default('root') }}"
          tags: [setup, builder_config, ansible_cfg]

        - name: Copy ansible.cfg to system locations
          ansible.builtin.copy:
            src: "{{ work_dir }}/_build/configs/ansible.cfg"
            dest: "{{ item }}"
            mode: '0644'
            remote_src: true
          with_items:
            - /etc/ansible/ansible.cfg
            - "{{ playbook_dir }}/ansible.cfg"

    #
    # SECTION 7: Image Management
    #
    - name: Check and pull required container images
      block:
        - name: Check if required container images exist
          ansible.builtin.command:
            cmd: "podman image exists {{ item }}"
          environment: "{{ podman_env }}"
          loop: "{{ required_images }}"
          register: image_check_results
          changed_when: false
          failed_when: false
          loop_control:
            label: "{{ item }}"
          tags: [setup, images, check_images]

        - name: Display missing images to pull
          ansible.builtin.set_fact:
            missing_images: "{{ image_check_results.results | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | map(attribute='item') | list }}"
          tags: [setup, images, identify_missing]

        - name: Show missing image count
          ansible.builtin.debug:
            msg: "Found {{ missing_images | length }} images that need to be pulled"
          tags: [setup, images, count_missing]

        # Skip subsequent tasks if no images are missing
        - name: Skip message when no images need to be pulled
          ansible.builtin.debug:
            msg: "All required images already present, skipping pull operations"
          when: missing_images | length == 0
          tags: [setup, images, skip_message]

        # Only run these tasks when images need to be pulled
        - name: Handle missing images
          when: missing_images | length > 0
          block:
            - name: Pull missing container images
              ansible.builtin.command:
                cmd: "podman pull {{ item }}"
              environment: "{{ podman_env }}"
              loop: "{{ missing_images }}"
              register: pull_results
              changed_when: pull_results.rc == 0
              failed_when: false
              retries: 3
              delay: 5
              until: pull_results is succeeded
              loop_control:
                label: "{{ item }}"
                pause: 1.0
              tags: [setup, images, pull_images]

            - name: Process image pull results
              ansible.builtin.set_fact:
                successful_pulls: "{{ pull_results.results | default([]) | selectattr('rc', 'defined') | selectattr('rc', 'eq', 0) | map(attribute='item') | list }}"
                failed_pulls: "{{ pull_results.results | default([]) | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | map(attribute='item') | list }}"
              tags: [setup, images, process_results]

            - name: Summarize image pull results
              ansible.builtin.debug:
                msg: |
                  Image Pull Summary:
                  ───────────────────────────
                  Successfully pulled images:
                  {% for image in successful_pulls | default([]) %}
                  - {{ image }}
                  {% endfor %}
                  
                  Failed to pull images:
                  {% for image in failed_pulls | default([]) %}
                  - {{ image }}
                  {% endfor %}
              tags: [setup, images, summarize]

            - name: Fail if any required images could not be pulled
              ansible.builtin.fail:
                msg: |
                  CRITICAL ERROR: Failed to pull the following required images:
                  {% for image in failed_pulls | default([]) %}
                  - {{ image }}
                  {% endfor %}
                  
                  These images are required for execution environment building.
                  Please check your network connection, registry authentication,
                  and ensure these images are accessible.
              when: failed_pulls is defined and failed_pulls | length > 0
              tags: [setup, images, validation]
          tags: [setup, images, pull_process]
      rescue:
        - name: Critical failure in image pulling
          ansible.builtin.fail:
            msg: |
              CRITICAL ERROR: Failed to pull required container images.
              This playbook cannot continue without the necessary base images.
              
              Please verify:
              1. Registry authentication is working (podman login)
              2. Network connectivity to container registries
              3. The required images exist and are accessible
      tags: [setup, images]

    #
    # SECTION 8: Dependencies Management
    #
    - name: Manage dependencies
      block:
        - name: Check if requirements.txt exists
          ansible.builtin.stat:
            path: "{{ work_dir }}/files/requirements.txt"
          register: requirements_txt

        - name: Install Python packages from requirements.txt
          ansible.builtin.pip:
            requirements: "{{ work_dir }}/files/requirements.txt"
            extra_args: "--upgrade"
          when: requirements_txt.stat.exists
          register: pip_install_result
          retries: 2
          delay: 3
          until: pip_install_result is succeeded
          failed_when: false

        - name: Check if requirements.yml exists
          ansible.builtin.stat:
            path: "{{ work_dir }}/files/requirements.yml"
          register: requirements_yml

        - name: Install ansible-galaxy collections
          ansible.builtin.command:
            cmd: ansible-galaxy collection install -r {{ work_dir }}/files/requirements.yml
          when: requirements_yml.stat.exists
          register: galaxy_install_result
          changed_when: galaxy_install_result.rc == 0
          failed_when: galaxy_install_result.rc != 0
          ignore_errors: true

    # 
    # SECTION 8.5: Environment Selection Filtering
    #
    - name: Filter available environments based on distribution selection
      block:
        - name: Get all available environments
          ansible.builtin.find:
            paths: "{{ work_dir }}/environments"
            file_type: directory
          register: all_environments
          
        - name: Process environments for filtering
          ansible.builtin.set_fact:
            rhel8_environments: "{{ all_environments.files | selectattr('path', 'search', 'rhel8') | map(attribute='path') | list }}"
            rhel9_environments: "{{ all_environments.files | selectattr('path', 'search', 'rhel9') | map(attribute='path') | list }}"
            neutral_environments: "{{ all_environments.files | rejectattr('path', 'search', 'rhel[89]') | map(attribute='path') | list }}"
            
        - name: Set available environments based on distribution selection
          ansible.builtin.set_fact:
            available_environments: "{{ 
                neutral_environments + 
                (build_rhel8 | bool) | ternary(rhel8_environments, []) + 
                (build_rhel9 | bool) | ternary(rhel9_environments, [])
              }}"
              
        - name: Debug available environments
          ansible.builtin.debug:
            msg: "Available environments based on distribution selection: {{ available_environments | map('basename') | list }}"
            
        # Pass the filtered environment list to the environment_menu.yml
        - name: Set environment_paths for menu
          ansible.builtin.set_fact:
            environment_paths: "{{ available_environments }}"
      when: build_rhel8 is defined or build_rhel9 is defined

    # 
    # Continue with environment selection, monitoring setup, etc.
    #
    - name: Include environment menu tasks
      ansible.builtin.include_tasks: tasks/environment_menu.yml
      register: environment_menu_result
      tags: [environment, menu, env_selection]

    - name: Debug selected environments
      ansible.builtin.debug:
        msg: "Selected environments to process: {{ selected_environments | join(', ') }}"
      when: selected_environments | default([]) | length > 0
      
    # SECTION 8: Monitoring Setup
    #
    - name: Setup basic podman monitoring
      block:
        - name: Ensure scripts directory exists
          ansible.builtin.file:
            path: "{{ playbook_dir }}/scripts"
            state: directory
            mode: '0755'
          tags: [monitoring, monitoring_dir]

        - name: Create monitoring script
          ansible.builtin.copy:
            dest: "{{ playbook_dir }}/scripts/start_monitor.sh"
            mode: '0755'
            content: |
              #!/bin/bash
              # Enhanced monitoring script for podman with auto-popup terminal and title screen

              # Kill any existing session
              tmux kill-session -t podman-monitor 2>/dev/null || true
              
              # Create the basic session
              tmux new-session -d -s podman-monitor
              
              # Configure the session with proper formatting
              tmux set -g status-style bg=black,fg=white
              tmux set -g default-terminal "screen-256color"
              tmux set -g terminal-overrides ",xterm-256color:Tc"
              
              # Set larger history limit for better scrollback
              tmux set -g history-limit 10000
              
              # Split into 2 panes
              tmux split-window -v -p 30
              
              # Put commands in each pane
              tmux select-pane -t 0
              
              # Clear screen and display tmux_header.txt as main title
              tmux send-keys "clear" C-m
              
              # Display the header file directly in the main pane
              if [ -f "{{ playbook_dir }}/tmux_header.txt" ]; then
                # Display the header with proper coloring
                tmux send-keys "cat {{ playbook_dir }}/tmux_header.txt" C-m
              else
                # Fallback if header file isn't found
                tmux send-keys "printf '\e[1;36m%s\e[0m\n' '=== BUILD OUTPUT ==='" C-m
                tmux send-keys "echo 'Waiting for builds to start...'" C-m
              fi

              # Configure second pane
              tmux select-pane -t 1
              tmux send-keys "printf '\e[1;32m%s\e[0m\n' '=== IMAGES ==='" C-m
              tmux send-keys "watch -n .5 'podman images'" C-m
              
              # Return to main pane
              tmux select-pane -t 0

              # Auto-open terminal with tmux session attached
              function open_terminal_with_tmux {
                # If we're already in tmux, create a new window
                if [ -n "$TMUX" ]; then
                  tmux new-window "tmux attach -t podman-monitor"
                  return 0
                fi
                
                # Try different terminal emulators
                for terminal in gnome-terminal konsole xfce4-terminal terminator mate-terminal x-terminal-emulator xterm; do
                  if command -v $terminal >/dev/null 2>&1; then
                    case $terminal in
                      gnome-terminal)
                        nohup $terminal --geometry=120x40 -- tmux attach -t podman-monitor >/dev/null 2>&1 &
                        ;;
                      konsole|xfce4-terminal|terminator|mate-terminal|x-terminal-emulator)
                        nohup $terminal --geometry=120x40 -e "tmux attach -t podman-monitor" >/dev/null 2>&1 &
                        ;;
                      xterm)
                        nohup $terminal -geometry 120x40 -e "tmux attach -t podman-monitor" >/dev/null 2>&1 &
                        ;;
                    esac
                    echo "Opened monitoring in $terminal"
                    return 0
                  fi
                done
                
                # WSL-specific handling
                if (grep -q Microsoft /proc/version 2>/dev/null); then
                  nohup cmd.exe /c start wt.exe -w 0 new-tab --title "Podman Monitor" bash -c "tmux attach -t podman-monitor" >/dev/null 2>&1 &
                  if [ $? -eq 0 ]; then
                    echo "Opened monitoring in Windows Terminal"
                    return 0
                  fi
                fi
                
                return 1
              }

              # Try to open terminal with tmux
              if ! open_terminal_with_tmux; then
                echo "Could not automatically open a terminal. Connect with: tmux attach -t podman-monitor"
              fi
          tags: [monitoring, monitoring_create_script]

        - name: Run monitoring script
          ansible.builtin.command: "{{ playbook_dir }}/scripts/start_monitor.sh"
          changed_when: true
          tags: [monitoring, monitoring_start]

        - name: Display monitoring instructions
          ansible.builtin.debug:
            msg: |
              ┌────────────────────────────────────────────────────────────────┐
              │                  BUILD MONITORING AVAILABLE                    │
              ├────────────────────────────────────────────────────────────────┤
              │ To monitor build progress, run:                                │
              │   tmux attach -t podman-monitor                                │
              └────────────────────────────────────────────────────────────────┘
          tags: [monitoring, monitoring_instructions]
      tags: [monitoring]

    - name: Set build_ready flag
      ansible.builtin.set_fact:
        build_ready: "{{ selected_environments | default([]) | length > 0 }}"
      tags: [build, build_set_ready_flag]

    - name: Build execution environments
      block:
        - name: Skip message if environment is not compatible with selected distributions
          ansible.builtin.debug:
            msg: "Skipping environment '{{ item }}' as it's not compatible with selected distributions."
          loop: "{{ selected_environments | default([]) }}"
          when: >
            (not build_rhel8 and 'rhel8' in item) or
            (not build_rhel9 and 'rhel9' in item)
          loop_control:
            label: "{{ item }}"
          tags: [build, build_process, skip_incompatible]
            
        - name: Build compatible selected environments
          include_tasks: tasks/build_environment.yml
          vars:
            current_env: "{{ item }}"  # Set current_env to the environment name
            environment_dir: "{{ work_dir }}/environments/{{ item }}"  # Add this missing variable
          loop: "{{ selected_environments }}"
          when: >
            (build_rhel8 and 'rhel8' in item) or
            (build_rhel9 and 'rhel9' in item) or
            ('rhel8' not in item and 'rhel9' not in item)
          loop_control:
            label: "{{ item }}"
          tags: [build, build_process, execute_environment]
      when: is_root and build_ready | default(false) | bool
      tags: [build]

    #
    # SECTION 10: Create Sample Environments
    #
    - name: Check for existing environments
      ansible.builtin.find:
        paths: "{{ work_dir }}/environments"
        file_type: directory
      register: existing_env_dirs
      
    - name: Create sample environment directories with clear RHEL version indicators
      ansible.builtin.file:
        path: "{{ work_dir }}/environments/{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - "rhel8"
        - "rhel9"
      when: existing_env_dirs.files | length == 0

    #
    # SECTION 11: Environment Filtering and Selection
    #
    - name: Filter available environments based on distribution selection
      block:
        - name: Get all available environments
          ansible.builtin.find:
            paths: "{{ work_dir }}/environments"
            file_type: directory
          register: all_environments
          
        - name: Display all discovered environments before filtering
          ansible.builtin.debug:
            msg: |
              All available environments before filtering:
              {% for env in all_environments.files %}
              - {{ env.path | basename }}
              {% endfor %}
        
        - name: Process environments for filtering
          ansible.builtin.set_fact:
            rhel8_environments: "{{ all_environments.files | selectattr('path', 'search', 'rhel8') | map(attribute='path') | list }}"
            rhel9_environments: "{{ all_environments.files | selectattr('path', 'search', 'rhel9') | map(attribute='path') | list }}"
            neutral_environments: "{{ all_environments.files | rejectattr('path', 'search', 'rhel[89]') | map(attribute='path') | list }}"

        - name: Display filtered environment lists
          ansible.builtin.debug:
            msg: |
              RHEL 8 environments: {{ rhel8_environments | map('basename') | list }}
              RHEL 9 environments: {{ rhel9_environments | map('basename') | list }}
              Neutral environments: {{ neutral_environments | map('basename') | list }}
            
        - name: Set available environments based on distribution selection
          ansible.builtin.set_fact:
            available_environments: "{{ 
                neutral_environments + 
                (build_rhel8 | bool) | ternary(rhel8_environments, []) + 
                (build_rhel9 | bool) | ternary(rhel9_environments, [])
              }}"
            environment_paths: "{{ 
                neutral_environments + 
                (build_rhel8 | bool) | ternary(rhel8_environments, []) + 
                (build_rhel9 | bool) | ternary(rhel9_environments, [])
              }}"
              
        - name: Display final filtered environment list
          ansible.builtin.debug:
            msg: |
              Final environment list for {{ (build_rhel8 | bool) | ternary('RHEL 8', '') }}{{ (build_rhel8 and build_rhel9) | ternary(' and ', '') }}{{ (build_rhel9 | bool) | ternary('RHEL 9', '') }}:
              {{ environment_paths | map('basename') | list }}
